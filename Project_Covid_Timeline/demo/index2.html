<!DOCTYPE html>
<meta charset="utf-8">

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Color scale -->
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<!-- Add 2 buttons -->
<button onclick="update(data1)">Data 1</button>
<button onclick="update(data2)">Data 2</button>

<!-- Create a div where the graph will take place -->
<div id="my_dataviz"></div>
<div class="tooltip"></div>

<style>
    .tooltip {
        position: absolute;
        pointer-events: none;
        background: #000;
        color: #fff;
    }
</style>

<script>

    let covidData = {}

    // set the dimensions and margins of the graph
    var width = 450
    height = 450
    margin = 40

    // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
    var radius = Math.min(width, height) / 2 - margin

    // append the svg object to the div called 'my_dataviz'
    var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")

    // create 2 data_set
    // var data1 = { a: 9, b: 20, c: 30, d: 8, e: 12 }
    var data1 = {}
    var data2 = { a: 6, b: 16, c: 20, d: 14, e: 19, f: 12 }
    var fileName = "Covid_2021_New.csv"
    var date = formatDate("9/6/2021")

    d3.csv("https://benflop.github.io/CSC3007-project/" + fileName,
        function (d) {
            // return { date : formatDate(d.date), value : parseInt(d.total_cases), detail: d.Events,content: d.Summary.substring(0, 110).replace("1.", "") + "...",eventUrl : d.Url,deaths: parseInt(d.total_deaths),new_case:parseInt(d.new_cases),new_death:parseInt(d.new_deaths)};
            var dDate = formatDate(d.date)

            if (date.getTime() === dDate.getTime()) {
                covidData.date = dDate
                //data1["cases"] = d.new(cases)
                // data1["cases"] = d.new(cases) 
                // data1.append("new_case", parseInt(d.new_cases))
                data1.cases = parseInt(d.new_cases)
                data1.death = parseInt(d.new_deaths);
                data1.c = 12
                console.log("Data1: " + JSON.stringify(data1))
                update(data1)

                // covidData.value = 
                // covidData.key = d.new_deaths
            }
            // data1["cases"] = d.new(cases)    
            // data1.cases = parseInt(d.new_cases)
            // data1.append("new_case", parseInt(d.new_cases))
            // console.log("Data1: " + JSON.stringify(data1))
            // update(data1)
            return data1

        },
        function (data) {
            // update(data)
            //    console.log(data)
            // console.log(covidData)

        })

    // set the color scale
    var color = d3.scaleOrdinal()
        .domain(["new_cases", "new_deaths"])
        .range(d3.schemeDark2);

    var tip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0)

    // A function that create / update the plot for a given variable:
    function update(data) {

        // Compute the position of each group on the pie:
        var pie = d3.pie()
            .value(function (d) { return d.value; })
            .sort(function (a, b) {
                console.log(a);
                return d3.ascending(a.key, b.key);
            }) // This make sure that group order remains the same in the pie chart
        var data_ready = pie(d3.entries(data))

        // map to data
        var u = svg.selectAll("path")
            .data(data_ready)
            .on("mouseover", function (d) {
                tip.style("opacity", 1)
                    .html("This is working")
                    .style("left", (d3.event.pageX - 25) + "px")
                    .style("top", (d3.event.pageY - 75) + "px")
            })
            .on("mouseout", function (d) {
                tip.style("opacity", 0)
            })

        // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
        u
            .enter()
            .append('path')
            .merge(u)
            .transition()
            .duration(1000)
            .attr('d', d3.arc()
                .innerRadius(0)
                .outerRadius(radius)
            )
            .attr('fill', function (d) { return (color(d.data.key)) })
            .attr("stroke", "white")
            .style("stroke-width", "2px")
            .style("opacity", 1)

        // remove the group that is not present anymore
        u
            .exit()
            .remove()

    }

    // Initialize the plot with the first dataset
    update(data1)
    // console.log(covidData)

    function formatDate(str) {
        var parts = str.split("/");
        var dt = new Date(parseInt(parts[2], 10),
            parseInt(parts[1], 10) - 1,
            parseInt(parts[0], 10));
        return dt;
    }

</script>